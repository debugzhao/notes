## 第06章 索引的数据结构

### 1.为什么使用索引

使用索引可以减少磁盘IO，提高查询效率。

### 2.索引及其优缺点

#### 2.1 索引概述

索引（Index）是帮助MySQL高效获取数据的数据结构。

#### 2.2 优点

1. 提高数据检索效率，降低数据库IO成本
2. 通过建立唯一索引， 可以保证数据库中每一行数据的唯一性
3. 可以加速表与表之间的连接

#### 2.3 缺点

1. 创建和维护索引需要消耗时间，并且随着数据量的增加，消耗的时间也会增加
2. 索引本身也会占用磁盘空间
3. 虽然索引会大大提高查询效率，但是同时也会降低更新表的效率

### 3.InnoDB中索引的推演

#### 3.1 索引之前的查找

#### 3.2 设计索引

##### 一个简单的索引设计方案

为了快速定位数据，我们需要建立一个目录，建立这个目录必须符合以下特点：

1. 下一个数据页中的数据的主键必须大于上一个数据页中的数据主键
2. 给所有也简历一个目录项

![image](https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.43n3prsata20.webp)

这个目录还有一个别名就是**索引**。

##### InnoDB中的索引方案

1. 第一次迭代：记录目录项的页

   ![image](https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.4c5iu2f89lu0.webp)

2. 第二次迭代：多个记录目录项的页

   ![image](https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.143w4l7h9hj4.webp)

3. 第三次迭代：目录页的目录页

   只要目录页超过两个，需要新键一个更高层级的目录页

   ![image](https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.5zqgo4vq6pk0.webp)

4. B+ Tree

   ![image](https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.7k02bo7d89k0.webp)

   以上数据结构就是B树

   假设`叶子节点`所代表的数据页可以存放`100条用户数据`，非`叶子节点`所代表的的数据页可以存放`1000条目录数据`，那么：

   - 如果B+树只有<font color="red">1层</font>，也就是只有1个用于存放用户记录的节点，最多能存放 <font color="red">100 条记录</font>
   - 如果B+树有<font color="red">2层</font>，最多能存放<font color="red"> 1000×100=10,0000 条记录</font>
   - 如果B+树有<font color="red">3层</font>，最多能存放 <font color="red">1000×1000×100=1,0000,0000 条记录</font>
   - 如果B+树有<font color="red">4层</font>，最多能存放 <font color="red">1000×1000×1000×100=1000,0000,0000 条记录</font>

   <font color="red">**所以一般情况下我们用到的B+树都不会超过4层。**</font>

#### 3.3 常见索引概念

索引按照物理实现方式，索引可以分为 2 种：聚簇（聚集）和非聚簇（非聚集）索引。我们也把非聚集 索引称为二级索引或者辅助索引。

##### 聚簇索引

1. 概念

   由主键构成的索引称为聚簇索引

2. 特点

   页内的记录是按照主键的大小顺序组成一个<font color="red">单项链表</font>

   页之间按照主键大小组成一个<font color="red">双向链表</font>

   <font color="red">B+树的叶子节点存储的是完整的用户数据</font>

3. 优点

   - 因为聚簇索引将索引和数据保存在同一个B+树中，所以从聚簇索引中查找数据比非聚簇索引中<font color="red">访问数据更快</font>
   - 聚簇索引对主键的排序查找和范围查找速度更快
   - 节省了大量的IO操作

4. 缺点

   - 插入速度严重依赖于插入顺序，因此我们一般会定义一个自增的ID作为主键
   - 更新主键的代价很高
   - <font color="red">访问二级索引需要进行两次索引查找，第一次找到主键值，第二次根据主键值找到行数据</font>
   
5. 限制

   - 对于MySQL数据库目前<font color="red">只有InnoDB引擎支持聚簇索引</font>，MyISAM不支持聚簇索引

   - 由于数据物理存储方式只能有一种，所以每个<font color="red">MySQL表只能有一个聚簇索引</font>。一般情况下是该表的主键

   - 如果没有定义主键，InnoDB会选择<font color="red">非空的唯一索引代替</font>。如果没有这样的索引，InnoDB会隐式定义一个主键来作为聚簇索引。

   - 为了充分利用聚簇索引聚簇的特性，索引InnoDB表主键尽量<font color="red">选择有序的顺序id</font>，不要选择无序的id，比如UUID，MD5，HASH、字符串列作为主键而无法保证数据的顺序增长。

     > 雪花算法生成的主键也是按照时间增长的。 

##### 二级索引

> 二级索引也称为辅助索引、非聚簇索引
>
> 一个数据库表中只能有一个聚簇索引，但是可以有多个非聚簇索引，即多个二级索引

1. 概念

   <font color="red">由非主键列创建的索引称为非聚簇索引</font>，即二级索引。<font color="red">二级索引的叶子节点只存储了索引列和主键列</font>，所以通过叶子节点可以观察出是否是二级索引。

2. 回表

   我们根据C2列关键字在二级索引B+树中查询到主键值，然后再根据主键值在聚簇索引B+树中查询其他字段，这种行为需要查询两次B+树的行为就成为回表

3. 问题

   **Q:** 为什么我们需要进行一次回表操作呢？直接把完整的用户记录放到二级索引的叶子结点中不行吗？

   **A：**如果表中的字段非常多的话这将造成非常大的冗余

##### 联合索引

同时为多个列建立索引称为联合索引，联合索引本质上也是二级索引。

![image](https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.4qk4sigaaiw0.webp)

#### 3.4 InnoDB的B+树索引的注意事项

##### 根页面位置万年不动

##### 内节点中目录项记录的唯一性

##### 一个页面最少存储两条记录

### 4.MyISAM的索引方案

#### 4.1 MyISAM索引的原理

#### 4.2 MyISAM和InnoDB对比

MyISAM的索引方式都是“非聚簇”的，与InnoDB包含1个聚簇索引是不同的。

### 5.索引的代价

1. 空间上的代价

   每建立一个索引就会为它创建一个B+树。每一个B+树的每一个节点都是一个数据页，一个数据页的默认占用16KB存储空间，一棵很大的B+树由许多数据页组成，那就是很大的一片存储空间。

2. 时间上的代价

   每次对表中的数据进行增、删、改操作都会去修改各个B+树的索引。如果我们创建了太多不必要的索引，反而会降低表的维护性能。

### 6.MySQL数据结构选择的合理性

#### 6.1 全表遍历

#### 6.2 Hash结构

![](https://s3.bmp.ovh/imgs/2022/05/17/a636ddf0b174e360.png)

哈希函数h有可能将两个不同的关键字映射到相同的位置，这叫做<font color="red">哈希碰撞</font>，在数据库中一般采用链接法 来解决。在链接法中，<font color="red">将散列到同一槽位的元素放在一个链表中。</font>

**Hash索引适用的存储引擎**

| 索引/存储引擎 | MyISAM | InnoDB | Memory                        |
| ------------- | ------ | ------ | ----------------------------- |
| HASH索引      | 不支持 | 不支持 | <font color="red">支持</font> |

**自适应Hash**

![](https://s3.bmp.ovh/imgs/2022/05/17/1766e3b0b1b951e9.png)

采用自适应 Hash 索引目的是方便根据 SQL 的查询条件加速定位到叶子节点，特别是当 B+ 树比较深的时 候，通过自适应 Hash 索引可以明显提高数据的检索效率。

#### 6.3 二叉搜索树

如果利用二叉树作为索引数据结构，那么磁盘的IO次数和索引树的高度是相关的。

1. 二叉搜索树的特点

   ![](https://i.bmp.ovh/imgs/2022/05/17/dcf60450345eb4c3.png)

2. 查找规则

   ![](https://i.bmp.ovh/imgs/2022/05/17/70474395173bfb79.png)

   ![](https://i.bmp.ovh/imgs/2022/05/17/2d5f9c57872052a7.png)

   上面这颗树也属于二分查找树，但是性能上已经退化成了链表的性能，所以查询数据的<font color="red">复杂度是O(n)</font>。为了提高查询效率，就需要<font color="red">减少磁盘IO</font>。为了减少磁盘IO就需要尽量<font color="red">降低树的高度</font>，需要把原来瘦高的树变成矮胖的树，即<font color="red">树每层的分叉越多越好</font>。

#### 6.4 AVL树

为了解决在特殊情况下二叉查找树退化成链表的问题，人们提出了<font color="red">平衡二叉树</font>，也称为AVL树。AVL树具有以下性质：<font color="red">它是一颗空树或者左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一个平衡二叉树。</font>

常见的平衡二叉树有：平衡二叉搜索胡、红黑树、树堆、伸展树，AVL树的查询的时间复杂度为O(log2n)

![image](https://raw.githubusercontent.com/Andre235/-community/master/src/image.1pkqidicy5j4.webp)

#### 6.5 B-Tree

B树英文称为Balance Tree，也就是多路平衡查找树。B树的高度远小于平衡二叉树的高度。B树作为多路平衡查找树，它的每一个节点最多可以包括M个子节点，<font color="red">M称为B树的阶</font>。每个磁盘块包含关键字和子节点的指针。

![image](https://raw.githubusercontent.com/Andre235/-community/master/src/image.15gc4e3acdek.webp)

B树区别于B+树，它的非叶子节点也是会存储数据的。

**小节**

1. B树在插入和删除的过程中可能会导致树的不平衡，此时需要调整节点的位置来保证树的自平衡
2. B树的关键字分布在整个树中，即叶子节点和非叶子节点都会存储数据。搜索有可能会在非叶子节点中结束
3. B树的搜索性能相当于在关键字全集内做了一次二分查找 

#### 6.6 B+Tree

B+树也是一种<font color="red">多路搜索树，基于B树做出了改进</font>，主流的DBMS都支持B+树的索引方式，比如MySQL。相比较于B树，<font color="red">B+树更适合与文件索引系统</font>。

**B+树和B树的区别在于**

1. 在B+树中，有K个关键字就有K个孩子节点，也就是孩子节点的数量 = 关键字的数量；在B树中，孩子节点的数量 = 关键字数量 + 1
2. 在B+树中，叶子节点的关键字也会出现在非叶子节点中，并且所有的子节点的关键字最大（或者最小）
3. 在B+树中，非叶子节点的关键字仅用于索引，不保存数据记录，跟记录有关的信息都存储在叶子节点中；但是在B树中，<font color="red">非叶子节点即用于索引又用户存储用户数据。</font>
4. 在B+树中所有的关键字都在叶子节点中出现，并且叶子结点构成了一个有序链表。而叶子节点本身是按照关键字大小有序连接的。

B+树的非叶子节点不直接存储数据，这样设计的好处在于：

1. <font color="red">B+树查询效率更稳定；</font>
2. <font color="red">B+树查询效率更高；</font>B+树查询效率更高，因为B+树存储的是索引，在数据页容量固定的情况下B+树可以存放更多的数据索引，也就是会有更多的关键字（跟多的分叉| 更多的子节点），从而树型结构更加矮胖，查询效率相对于B树更高；
3. <font color="red">在范围查询上B+树得查询效率也比B树更高。</font>这是因为所有的关键字都会出现在B+树的叶子节点中，并且叶子节点又是一个有序的链表，我们通过指针的方式可以更高效地进行范围查找。但是在B树中需要通过中序遍历才能够实现范围查找， 效率要低很多。

**面试题：**

1. 为了减少IO，索引树会一次性加载吗？

   数据库所以是存储在磁盘上的，如果数据量非常大的话那么索引也会很大，有时候甚至会超过几个G，所以是不可能会直接将索引都加载进内存的，这样会对极大消耗CPU资源。通常的做法是：逐一加载索引树的磁盘页，因为每个磁盘页对应着B+树的节点

2. B+树的存储能力如何？为何说一般查找行记录，最多只需要1-3次IO?

   <font color="red">InnoDB存储引擎的页的大小默认为16KB</font>，一般表的主键类型为INT类型（占4字节），也就是一个页大概可以存储1k个键值（10 ^ 3个键值）。也就是说数据<font color="red">深度为3的B+树中可以维护10 ^ 3 * 10 ^ 3 * 10 ^ 3 = 10亿条记录</font>。

   实际上每个节点可能不能被填充满，因此在<font color="red">数据库中B+树的高度一般在2-4层</font>。MySQL的InnoDB存储引擎在设计时将根节点的信息常驻内存，也就是说查找某一个键值的行记录是最多需要 1- 3次磁盘的IO操作。

3. 为什么说B+树比B树更适合做实际应用中的文件索引和数据库索引？

   由于B+树中非叶子节点存储的是子节点的索引，不直接存储数据，所以一个节点的能够容纳的关键字的数量也就更过，一次性读入内存的关键字也就更多，相对来说磁盘的IO次数就降低了。

   B+树的查询效率更加稳定																																			`

4. Hash索引和B+树索引的区别？

   - Hash索引不能进行范围查询（Hash索引指向的数据是无需的），但是B+树支持范围查询（B+树中叶子节点是一个有序的链表）
   - Hash索引不支持联合索引的最左匹配原则
   - Hash索引不支持排序查询（ORDER BY），也无法支持模糊匹配

5. Hash索引和B+树索引是在键索引的时候手动指定的吗

   针对InnoDB和MyISAM存储引擎默认实用的是B+树索引，无法使用Hash索引。InnoDB存储引擎提供的自适应Hash索引也无需手动指定

#### 6.7 R树

<font color="red">R树在MySQL很少使用，仅支持geometry数据类型。解决了在地图业务中高维空间搜索的问题。</font>

## 第08章 索引的创建和设计原则

### 1.索引的声明和使用

#### 1.1索引的分类

#### 1.2创建索引

#### 1.3删除索引

### 2.MySQL8.0索引新特性

#### 2.1支持降序索引

#### 2.2隐藏索引

### 3.索引的设计原则

#### 3.1数据的准备

#### 3.2哪些情况下适合创建索引

#### 3.3限制索引的数目

#### 3.2哪些情况下不适合创建索引

















<font color="red"></font>