## Java内存区域与内存溢出异常

#### 1.运行时数据区域

这些运行时数据区各有各自的用途，以及创建时间和销毁时间。有的运行时数据区随着虚拟机进程的启动而一直存在，有的数据区域则是依赖用户进程的启动和结束而创建和销毁

**Java运行时内存区域模型图**

<img src="https://i.loli.net/2020/09/30/L2n415UPcak7EMB.png" alt="Java运行时数据区内存模型" style="zoom:80%;" />

#### 2.程序计数器

##### 2.1概念

程序计数器是一块较小的内存空间，它可以看做是当前线程所执行的字节码的行号指示器

在Java虚拟机模型中，字节码解释器工作时就是通过改变计数器的值来确定下一条要执行的字节码指令

##### 2.2作用

它是程序控制流的指示器，程序的分支、循环、跳转、异常处理、线程恢复等基本功能都需要通过程序计数器来完成

##### 2.3在多线程中的应用

Java虚拟机的多线程是通过多个线程轮流切换，分配处理机的执行时间来完成的，在任何一个确定的时刻 一个处理机（对多核处理器来说是一个内核）只会执行一个线程中的指令。*因此，为了线程切换后能过恢复到正确的执行位置，每个线程内部都需要一个独立的程序计数器来保存当前线程所执行到得字节码位置*

各个线程的程序计数器互不影响，独立存储，我们称这块内存为线程私有内存

##### 2.4执行不同方法记录的数据

如果线程执行的是Java方法，程序计数器记录的是当前线程执行的字节码指令地址；如果执行的是本地 `native` 方法，这个计数器则为空

##### 2.5异常

程序计数器不会抛出内存溢出异常 `OutOfMemoryError`

#### 3.虚拟机栈

##### 3.1概念

虚拟机栈描述的是Java方法执行的线程内存模型。每个方法执行的时候虚拟机栈都会同步创建一个栈帧，用以存储局部变量表、操作数栈、动态链接、方法出口等信息。每个方法从被调用到执行完毕的过程中都对应着一个栈帧在虚拟机栈的入栈到出栈操作

##### 3.2生命周期

和程序计数器一样，Java虚拟机栈也是线程私有的，它的生命周期和线程的生命周期相同

##### 3.3局部变量槽

在下文中`虚拟机栈`通常指的是虚拟机栈中的`局部变量表`。在局部变量表中存放者基本数据类型和引用数据类型（这里的引用数据类型指的不是对象本身，而是一个指向对象起始地址的引用指针）。这些数据在局部变量表中以局部变量槽 `slot`表示，当进入一个方法时，这个方法的局部变量表所需要占用的内存空间是完全确定的。

##### 3.4异常

1. 如果线程请求的栈的深度大于虚拟机所允许的最大深度，程序将会抛出栈溢出异常 `StackOverFlowError`
2. 如果Java虚拟机栈容量可以动态扩展，当栈扩展到无法申请足够多的内存时会抛出内存溢出异常 `OutOfMemoryError`

#### 4.本地方法栈

##### 4.1概念

本地方法栈 `Native Method Stack`与虚拟机栈所发挥的作用是非常类似的，不同的是虚拟机栈只为虚拟机提供执行`Java`方法服务（即执行字节码指令），但是本地方法栈只为虚拟机提供`Native`本地方法服务。

##### 4.2异常

1. 栈溢出异常
2. 内存溢出异常

#### 5.堆内存

##### 5.1概念

Java堆是虚拟机管理的最大的一块内存区域，同时也是所有线程内存共享的一块区域，同时也是垃圾回收 `Garbage Collected Heap` 的地方

为了提高给对象分配内存的效率，原本由所有线程共享的Java堆可以划分成多个线程私有的分配缓冲区

Java堆可以处于物理上连续的内存空间，也可以处于不连续的内存空间

##### 5.2异常

如果在Java堆中没有足够多的内存给对象分配空间，且堆不能够再扩展时，虚拟机将会抛出内存溢出异常

#### 6.方法区

##### 6.1概念

方法区和堆一样，可以处于物理上不连续的内存空间上；可以选择固定大小或者可扩展的内存空间

##### 6.2作用

方法区主要进行常量的回收和类型的卸载，但是这块的内存回收效果不是很理想

##### 6.3异常

在方法区内如果无法申请到足够多的内存时就会抛出内存溢出异常

