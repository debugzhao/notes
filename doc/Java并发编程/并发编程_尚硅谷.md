## åŸºç¡€æ¦‚å¿µ
##### ç”¨æˆ·çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹

1.  ç”¨æˆ·çº¿ç¨‹

 æ˜¯ç”±ç”¨æˆ·åˆ›å»ºçš„çº¿ç¨‹

2.  å®ˆæŠ¤çº¿ç¨‹

æ˜¯ä¸ºå…¶ä»–çº¿ç¨‹æœåŠ¡çš„ç‰¹æ®Šçº¿ç¨‹ï¼ˆGCçº¿ç¨‹ï¼‰ï¼Œ ç”¨æˆ·çº¿ç¨‹å…¨éƒ¨æ¶ˆäº¡åˆ™å®ˆæŠ¤çº¿ç¨‹ä¹Ÿå¼€å§‹å…¨éƒ¨æ¶ˆäº¡ã€‚
__d.start()æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œå¦åˆ™ç¨‹åºä¼šæŠ›å¼‚å¸¸ã€‚_		
## CompletableFuture
###  Futureæ¥å£ç†è®ºçŸ¥è¯†å¤ä¹ 
Futureæ¥å£å®šä¹‰äº†æ“ä½œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„æ–¹æ³•ï¼Œä¾‹å¦‚è·å–å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€ å–æ¶ˆå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€åˆ¤æ–­å¼‚æ­¥ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€åˆ¤æ–­å¼‚æ­¥ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ã€‚
```java
/**
* @author lucas.zhao
* @date 2022/8/7 15:47
* @description FutureTaskå¼‚æ­¥ä»»åŠ¡çš„ä½¿ç”¨
*/
public class CompletableFutureDemo {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        FutureTask<String> futureTask = new FutureTask<>(new MyThread());
        Thread thread1 = new Thread(futureTask, "thread1");
        thread1.start();
        System.out.println("å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æœï¼š" + futureTask.get());
    }
}

class MyThread implements Callable<String> {
    
    @Override
    public String call() throws Exception {
        System.out.println("call method called......");
        return "hello callable";
    }
}
```
####  Futureç¼–ç å®æˆ˜
```java
/**
 * @author lucas.zhao
 * @date 2022/8/7 16:06
 * @description  çº¿ç¨‹æ± çš„ä½¿ç”¨
 */
public class FutureThreadPoolDemo {
    public static void main(String[] args) throws InterruptedException, ExecutionException {
         func();
        // åˆ›å»ºå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹
        long startTime = System.currentTimeMillis();
        ExecutorService threadPool = Executors.newFixedThreadPool(3);
        FutureTask<String> futureTask1 = new FutureTask<>(() -> {
            TimeUnit.MILLISECONDS.sleep(500);
            return "task1 over";
        });
        threadPool.submit(futureTask1);

        FutureTask<String> futureTask2 = new FutureTask<>(() -> {
            TimeUnit.MILLISECONDS.sleep(300);
            return "task2 over";
        });
        threadPool.submit(futureTask2);
        System.out.println(futureTask1.get());
        System.out.println(futureTask2.get());

        TimeUnit.MILLISECONDS.sleep(400);

        long endTime = System.currentTimeMillis();
        System.out.println("è€—æ—¶ï¼š" + (endTime - startTime) + "æ¯«ç§’");
        System.out.println(Thread.currentThread().getName() + "----end");
        // é‡Šæ”¾èµ„æº
        threadPool.shutdown();
    }

    private static void func() throws InterruptedException {
        long startTime = System.currentTimeMillis();
        // å½“å‰æœ‰ä¸‰ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œç”±mainçº¿ç¨‹æ‰§è¡Œï¼Œè€—æ—¶å¤šå°‘æ¯«ç§’å¯ä»¥æ‰§è¡Œç»“æŸï¼Ÿ
        TimeUnit.MILLISECONDS.sleep(500);
        TimeUnit.MILLISECONDS.sleep(300);
        TimeUnit.MILLISECONDS.sleep(400);
        long endTime = System.currentTimeMillis();
        System.out.println("è€—æ—¶ï¼š" + (endTime - startTime) + "æ¯«ç§’");
        System.out.println(Thread.currentThread().getName() + "----end");
    }
}
```
####  Futureæ¥å£ä¼˜ç¼ºç‚¹

1. ä¼˜ç‚¹
1. ç¼ºç‚¹
   1. geté˜»å¡

getæ–¹æ³•å®¹æ˜“é˜»å¡ï¼Œä¸€æ—¦è°ƒç”¨getæ–¹æ³•å¦‚æœè®¡ç®—ç»“æœæ²¡æœ‰å®Œæˆï¼Œç¨‹åºå®¹æ˜“é˜»å¡ã€‚
	 å¦‚æœæƒ³è¦å¼‚æ­¥åœ°è·å–ç»“æœï¼Œå¯ä»¥é€šè¿‡è½®è¯¢åœ°æ–¹å¼è·å–ç»“æœï¼Œè¿™æ ·ç¨‹åºä¸ä¼šé˜»å¡ã€‚
```java
while (true) {
	if(futureTask1.isDone()) {
		futureTask1.get();
		break;
	} else {
		TimeUnit.MILLISECONDS.sleep(500);
	}
}
```

   2.  isDoneè½®è¯¢ 

è½®è¯¢åœ°æ–¹å¼ä¼šæ¶ˆè€—æ— è°“çš„CPUèµ„æºï¼Œå¹¶ä¸”ä¹Ÿä¸è§å¾—ä¼šåŠæ—¶è·å¾—è®¡ç®—ç»“æœã€‚
#### ç»“è®º
Futureæ¥å£å¯¹ç»“æœçš„è·å–ä¸æ˜¯å¾ˆå‹å¥½ï¼Œåªèƒ½é€šè¿‡è½®è¯¢æˆ–è€…é˜»å¡åœ°æ–¹å¼è·å–ç»“æœã€‚
###  Futureå¸¸ç”¨å®ç°ç±»FutureTaskå¼‚æ­¥ä»»åŠ¡
### CompletableFutureå¯¹Futureçš„æ”¹è¿›
### æ¡ˆä¾‹ç²¾è®²ï¼ˆç”µå•†ç½‘ç«™æ¯”ä»·éœ€æ±‚ï¼‰
### CompletableFutureå¸¸ç”¨æ–¹æ³•
## è¯´è¯´Javaé”äº‹
### ä¸€çº¿å¤§å‚é¢è¯•é¢˜

1. ä½ æ˜¯å¦‚ä½•ç†è§£Javaå¤šçº¿ç¨‹çš„ï¼Ÿ æ€ä¹ˆå¤„ç†å¹¶å‘çš„ï¼Ÿ çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°æœ‰å“ªäº›ï¼Ÿ
1.  JavaåŠ é”æœ‰å“ªå‡ ç§é”
1.  ç®€å•è¯´ä¸‹Lock
1.  hashmapçš„å®ç°åŸç†ï¼Ÿhashå†²çªå¦‚ä½•è§£å†³ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨çº¢é»‘æ ‘
1.   Springé‡Œé¢éƒ½ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿå¾ªç¯ä¾èµ–æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ
1.  Synchronizedç”¨è¿‡å—ï¼Ÿ åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
1. è·å–å¯¹è±¡çš„é”ï¼Œè¿™ä¸ªé”åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ç¡®å®šå¯¹è±¡çš„é”ï¼Ÿ
1.  ä»€ä¹ˆæ˜¯å¯é‡å…¥é”ï¼Ÿä¸ºä»€ä¹ˆè¯´Synchronizedæ˜¯å¯é‡å…¥é”ï¼Ÿ
1. JVM å¯¹Javaçš„åŸç”Ÿé”éƒ½åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ
1. ä¸ºä»€ä¹ˆè¯´Synchronizedæ˜¯éå…¬å¹³é”ï¼Ÿ
1. ä¸ºä»€ä¹ˆè¯´Synchronizedæ˜¯ä¸€ä¸ªæ‚²è§‚é”ï¼Ÿä¹è§‚é”çš„å®ç°åŸç†åˆæ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯AQSï¼Œå®ƒæœ‰ä»€ä¹ˆç‰¹æ€§ï¼Ÿ
1.  ä¹è§‚é”å°±ä¸€å®šæ˜¯å¥½çš„å—ï¼Ÿ
1.  å’ŒSynchronizedç›¸æ¯”ï¼Œå¯é‡å…¥é”ReentrantLockå®ç°åŸç†æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ
1.  ä½ å¯¹AQSæ¡†æ¶çš„ç†è§£ï¼Ÿ
1.  Synchronizedå’ŒReentrantLockçš„å¼‚åŒ
1.  ReentrantLockæ˜¯å¦‚ä½•å®ç°å¯é‡å…¥çš„ï¼Ÿ
### ä¹è§‚é”ã€æ‚²è§‚é”
#### æ‚²è§‚é”
æ¦‚å¿µï¼šæ‚²è§‚é”è®¤ä¸ºè‡ªå·±çš„ä½¿ç”¨æ•°æ®çš„æ—¶å€™ä¸€å®šæœ‰åˆ«çš„çº¿ç¨‹ä¼šä¿®æ”¹æ•°æ®ï¼Œå› æ­¤åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ã€‚
æ‚²è§‚é”å®ç°ï¼šSynchronizedå’ŒLockçš„å®ç°ç±»éƒ½æ˜¯æ‚²è§‚é”çš„å®ç°ã€‚
åº”ç”¨åœºæ™¯ï¼šé€‚ç”¨äºå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œå…ˆåŠ é”å¯ä»¥ä¿è¯å†™æ“ä½œæ—¶æ•°æ®çš„æ­£ç¡®æ€§ã€‚ 
#### ä¹è§‚é”
æ¦‚å¿µï¼šä¹è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®æˆ–è€…èµ„æºï¼Œæ‰€ä»¥ä¸ä¼šå»åŠ é”ã€‚
Javaä¸­çš„å®ç°ï¼šJavaä¸­æ—¶é€šè¿‡æ— é”ç¼–ç¨‹çš„æ–¹å¼å»å®ç°çš„ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹è¿‡è¿™ä¸ªæ•°æ®ï¼ˆéœ€è¦è€ƒè™‘ABAé—®é¢˜ï¼‰
ä¹è§‚é”åº”ç”¨åœºæ™¯ï¼šé€‚åˆè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œä¸åŠ é”å¯ä»¥æé«˜è¯»æ“ä½œçš„æ€§èƒ½ã€‚
ä¹è§‚é”å®ç°æ–¹å¼ï¼š

1. ç‰ˆæœ¬å·æœºåˆ¶Version
1. æœ€å¸¸é‡‡ç”¨CASç®—æ³•ï¼ŒJavaä¸­çš„åŸå­ç±»çš„é€’å¢æ“ä½œå°±æ˜¯é€šè¿‡CASè‡ªæ—‹å®ç°çš„ã€‚
### çº¿ç¨‹8é”
èƒ½ä½¿ç”¨å¯¹è±¡é”å°±ä¸è¦ä½¿ç”¨ç±»é”ã€‚
####  Synchronized
å®ç°æ–¹å¼ï¼šä½¿ç”¨çš„æ˜¯monitiorenterå’ŒmonitorexitæŒ‡ä»¤å®ç°çš„ã€‚

1. SynchronizedåŒæ­¥ä»£ç å—

 ä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªmonitiorenteræŒ‡ä»¤å¯¹åº”ç€ä¸¤ä¸ªmonitorexitæŒ‡ä»¤ï¼ˆç¨‹åºæ­£å¸¸é€€å¯¹åº”ç€ä¸€ä¸ªmonitorexitæŒ‡ä»¤ï¼Œ 		ç¨‹åºå¼‚å¸¸é€€å‡ºéœ€è¦ä¸€ä¸ªmonitorexitæŒ‡ä»¤ï¼‰

2. Synchronizedæ™®é€šåŒæ­¥æ–¹æ³•
2. Synchronizedé™æ€åŒæ­¥æ–¹æ³•

 é¢è¯•é¢˜ï¼š ä¸ºä»€ä¹ˆä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥æˆä¸ºé”ï¼Ÿ
å› ä¸ºæ‰€æœ‰å¯¹è±¡å†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªé”çŠ¶æ€ï¼ŒJavaåŒæ­¥æœºåˆ¶å°±æ˜¯ä½¿ç”¨äº†å¯¹è±¡ä¸­çš„é”çŠ¶æ€ä½œä¸ºé”æ ‡è¯†ã€‚
### å…¬å¹³é”ã€éå…¬å¹³é”
```java
/**
 * èµ„æºç±»ï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªå”®ç¥¨å‘˜å–å®Œ50å¼ ç¥¨
 */
class Ticket {
     private int num = 50;
    /**
     *  ReentrantLocké»˜è®¤æ„é€ éå…¬å¹³é”
     */
    ReentrantLock lock = new ReentrantLock(true);

      public void sale() {
          lock.tryLock();
           try {
               if (num > 0) {
                   System.out.println(Thread.currentThread().getName() + "å–å‡ºç¬¬ï¼š" + num -- + "\t" + "è¿˜å‰©ï¼š" + num);
               }
           } finally {
               lock.unlock();
           }
      }
}

public class SaleTicketDemo {
    public static void main(String[] args) {
        Ticket ticket = new Ticket();

        new Thread(() -> {
            for (int i = 0; i < 55; i++) {
                ticket.sale();
            }
        }, "A").start();

        new Thread(() -> {
            for (int i = 0; i < 55; i++) {
                ticket.sale();
            }
        }, "B").start();

        new Thread(() -> {
            for (int i = 0; i < 55; i++) {
                ticket.sale();
            }
        }, "C").start();
    }
}
```

1. å…¬å¹³é” 

æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºè·å–é”

2. éå…¬å¹³é”

å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºè¿›è¡Œçš„ã€‚åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹æœ‰å¯èƒ½é€ æˆçº¿ç¨‹ä¼˜å…ˆçº§åè½¬æˆ–è€…ä½¿çº¿ç¨‹å¤„äºé¥¥é¥¿çŠ¶æ€ã€‚
**ä¸ºä»€ä¹ˆé»˜è®¤éå…¬å¹³é”ï¼Ÿ**

1. æ¢å¤æŒ‚èµ·çš„çº¿ç¨‹åˆ°è·å¾—é”æ˜¯æœ‰æ—¶é—´å·®çš„ï¼Œæ‰€ä»¥éå…¬å¹³é”å¯ä»¥æ›´èƒ½å……åˆ†åˆ©ç”¨CPUçš„æ—¶é—´ç‰‡ï¼Œå‡å°‘CPUçš„ç©ºé—²çŠ¶æ€
1. åˆšåˆšé‡Šæ”¾é”çš„çº¿ç¨‹å†æ¬¡è·å–åŒæ­¥çŠ¶æ€çš„æ¦‚ç‡æ˜¯éå¸¸å¤§çš„ï¼Œæ‰€ä»¥é‡‡ç”¨éå…¬å¹³é”å¯ä»¥é™ä½çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢å¼€é”€
### å¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰
####  å¯é‡å…¥é”æ¦‚å¿µ
å¯é‡å…¥é”æŒ‡çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥ è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼ˆå‰ææ˜¯é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰è·å–é”æ²¡æœ‰é‡Šæ”¾è€Œé˜»å¡ã€‚
> ç®€è€Œè¨€ä¹‹ï¼šåŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚è·å–é”ä¹‹åï¼Œåœ¨å†…å±‚å¯ä»¥é‡å¤è·å–é”ï¼Œå¹¶ä¸”ä¸ä¼šå› ä¸ºå‰é¢çš„é”æ²¡æœ‰é‡Šæ”¾è€Œé˜»å¡ã€ä¸ä¼šå‘ç”Ÿæ­»é”ï¼Œè¿™ç§é”å°±æ˜¯å¯é‡å…¥é”ã€‚

Reentrant Lockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¼˜ç‚¹å¯ä»¥ä¸€å®šç¨‹åº¦åœ°é¿å…æ­»é”ã€‚
#### å¯é‡å…¥é”çš„ç§ç±»

1.  éšå¼å¯é‡å…¥é”ï¼ˆsynchronizedï¼‰
   1. åŒæ­¥å—å½¢å¼å¯é‡å…¥é”
```java
private static void reEntryLockFun1() {
	final Object lock = new Object();
	new Thread(() -> {
		synchronized (lock) {
			System.out.println(Thread.currentThread().getName() + "  å¤–å±‚è°ƒç”¨");
			synchronized (lock) {
				System.out.println(Thread.currentThread().getName() + "  ä¸­å±‚è°ƒç”¨");
				synchronized (lock) {
					System.out.println(Thread.currentThread().getName() + "  å†…å±‚è°ƒç”¨");
				}
			}
		}
	}, "thead1").start();
}

// thead1  å¤–å±‚è°ƒç”¨
// thead1  ä¸­å±‚è°ƒç”¨
// thead1  å†…å±‚è°ƒç”¨
```

   2. åŒæ­¥æ–¹æ³•å½¢å¼å¯é‡å…¥é”
```java
public static void main(String[] args) {
	// reEntryLockFun1();
	ReEntryLockDemo demo = new ReEntryLockDemo();
	new Thread(() -> {
		demo.fun1();
	}, "thread1").start();
}

private synchronized void fun1() {
	System.out.println("fun1 start " + Thread.currentThread().getName());
	fun2();
	System.out.println("fun1 end "+ Thread.currentThread().getName());
}

private synchronized void fun2() {
	System.out.println("fun2 start "+ Thread.currentThread().getName());
	fun3();
	System.out.println("fun2 end "+ Thread.currentThread().getName());

}

private synchronized void fun3() {
	System.out.println("fun3 start "+ Thread.currentThread().getName());
	System.out.println("fun3 end "+ Thread.currentThread().getName());
}

// fun1 start thread1
// fun2 start thread1
// fun3 start thread1
// fun3 end thread1
// fun2 end thread1
// fun1 end thread1
```

2.  æ˜¾å¼å¯é‡å…¥é”ï¼ˆReentrantLockï¼‰
```java
ReentrantLock lock = new ReentrantLock();
new Thread(() -> {
	lock.lock();
	try {
		System.out.println(Thread.currentThread().getName() + " come in");

		lock.lock();
		try {
			System.out.println(Thread.currentThread().getName() + " come in");
		} finally {
			lock.unlock();
		}
	} finally {
		// æ­£å¸¸æƒ…å†µä¸‹åŠ é”å‡ æ¬¡å°±éœ€è¦è§£é”å‡ æ¬¡
		// å¦‚æœåŠ é”çš„æ¬¡æ•°å’Œè§£é”çš„æ¬¡æ•°ä¸ä¸€æ ·ï¼Œé”è®¡æ•°å™¨å°±ä¸ä¼šä¸ºé›¶ï¼Œå…¶ä»–çº¿ç¨‹å°±ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€
		lock.unlock();
	}
}, "thread1").start();

new Thread(() -> {
	lock.lock();
	try {
		System.out.println(Thread.currentThread().getName() + " come in");
	} finally {
		lock.unlock();
	}
}, "thread2").start();
```

3.  éšå¼å¯é‡å…¥é”ï¼ˆsynchronizedï¼‰å®ç°åŸç†

æ¯ä¸€ä¸ªé”å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªé”è®¡æ•°å™¨å’ŒæŒ‡å‘æŒæœ‰è¯¥é”çš„çº¿ç¨‹çš„æŒ‡é’ˆã€‚ 

   1. å½“æ‰§è¡Œmonitorenteræ—¶ï¼Œå¦‚æœç›®æ ‡é”å¯¹è±¡çš„é”è®¡æ•°å™¨ä¸ºé›¶ï¼Œè¯´æ˜å½“å‰é”å¯¹è±¡å¹¶æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼ŒJVMå°±ä¼šå°†é”å¯¹è±¡çš„çº¿ç¨‹æŒ‡é’ˆè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”é”è®¡æ•°å™¨ +1
   1. å¦‚æœé”è®¡æ•°å™¨ä¸ä¸ºé›¶ï¼Œå¦‚æœé”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹æ—¶å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆJVMå°†é”è®¡æ•°å™¨+1ï¼Œå¦åˆ™éœ€è¦ç­‰å¾…ï¼Œç›´è‡³çº¿ç¨‹é‡Šæ”¾è¯¥é”
   1. å½“æ‰§è¡Œmonitorexitæ—¶ï¼ŒJVMå°†é”è®¡æ•°å™¨ -1ã€‚å¦‚æœé”è®¡æ•°å™¨ä¸ºé›¶è¯´æ˜è¯¥é”å·²ç»è¢«é‡Šæ”¾
### æ­»é”åŠå…¶æ’æŸ¥

#### æ­»é”æ¦‚å¿µ

æ­»é”æŒ‡çš„æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å› ä¸ºäº‰å¤ºèµ„æºè€Œé€ æˆäº’ç›¸ç­‰å¾…çš„æƒ…å†µã€‚

<img src="https://s3.bmp.ovh/imgs/2022/08/13/1ec200db555fe254.jpg" style="zoom:50%;" />

#### æ­»é”ä»£ç å®ä¾‹

```java
public class DeadLockDemo1 {
    public static void main(String[] args) {
        Object lockA = new Object();
        Object lockB = new Object();

         new Thread(() -> {
             synchronized (lockA) {
                 System.out.println(Thread.currentThread().getName() + "\t è‡ªå·±æŒæœ‰Aé”ï¼Œå¸Œæœ›è·å–Bé”");
                 try {
                     TimeUnit.SECONDS.sleep(1);
                 } catch (InterruptedException e) {
                     throw new RuntimeException(e);
                 }
                 synchronized (lockB) {
                     System.out.println(Thread.currentThread().getName() + "\t æˆåŠŸè·å–Bé”");
                 }
             }
         }, "thread1").start();

        new Thread(() -> {
            synchronized (lockB) {
                System.out.println(Thread.currentThread().getName() + "\t è‡ªå·±æŒæœ‰Bé”ï¼Œå¸Œæœ›è·å–Aé”");
                try {
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                synchronized (lockA) {
                    System.out.println(Thread.currentThread().getName() + "\t æˆåŠŸè·å–Aé”");
                }
            }
        }, "thread2").start();
    }
}


// thread1	 è‡ªå·±æŒæœ‰Aé”ï¼Œå¸Œæœ›è·å–Bé”
// thread2	 è‡ªå·±æŒæœ‰Bé”ï¼Œå¸Œæœ›è·å–Aé”
```

#### æ­»é”æ’æŸ¥åˆ†æ

``` shell
# æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„Javaè¿›ç¨‹ï¼ˆjpsç›¸å½“äºJavaç‰ˆæœ¬çš„psï¼‰
jps -l
# jstackæŸ¥çœ‹å½“å‰Javaè¿›ç¨‹çš„å †æ ˆä¿¡æ¯
jstack pid
```

```java
lucas@zhaojingchaodeMacBook-Pro JUC % jps -l
1312 
3249 org.jetbrains.jps.cmdline.Launcher
3250 com.geek.demo.DeadLockDemo1
3260 sun.tools.jps.Jps
```

```shell
lucas@zhaojingchaodeMacBook-Pro JUC % jstack 3250
2022-08-13 15:31:51
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.281-b09 mixed mode):

"Attach Listener" #16 daemon prio=9 os_prio=31 tid=0x00007ff40a01c000 nid=0x9803 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"DestroyJavaVM" #15 prio=5 os_prio=31 tid=0x00007ff40a009000 nid=0x2603 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

Found one Java-level deadlock:
=============================
"thread2":
  waiting to lock monitor 0x00007ff41a0190b8 (object 0x000000076aefee60, a java.lang.Object),
  which is held by "thread1"
"thread1":
  waiting to lock monitor 0x00007ff41a01b9f8 (object 0x000000076aefee70, a java.lang.Object),
  which is held by "thread2"

Java stack information for the threads listed above:
===================================================
"thread2":
        at com.geek.demo.DeadLockDemo1.lambda$main$1(DeadLockDemo1.java:38)
        - waiting to lock <0x000000076aefee60> (a java.lang.Object)
        - locked <0x000000076aefee70> (a java.lang.Object)
        at com.geek.demo.DeadLockDemo1$$Lambda$2/1983747920.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
"thread1":
        at com.geek.demo.DeadLockDemo1.lambda$main$0(DeadLockDemo1.java:24)
        - waiting to lock <0x000000076aefee70> (a java.lang.Object)
        - locked <0x000000076aefee60> (a java.lang.Object)
        at com.geek.demo.DeadLockDemo1$$Lambda$1/611437735.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.
```

é€šè¿‡æŸ¥çœ‹Javaå †æ ˆä¿¡æ¯å¯çŸ¥æœ‰ä¸€ä¸ªæ­»é”ã€‚thread2æŒæœ‰`0x000000076aefee70`é”å¯¹è±¡ï¼Œæ­£åœ¨ç­‰å¾…`0x000000076aefee60`é”å¯¹è±¡ï¼Œthread1æŒæœ‰`0x000000076aefee60`é”å¯¹è±¡ï¼Œæ­£åœ¨ç­‰å¾…`0x000000076aefee70`é”å¯¹è±¡ã€‚ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„é”ï¼Œæœ€ç»ˆé€ æˆæ­»é”ã€‚ 

### å†™æ‰€ï¼ˆç‹¬å é”ï¼‰ã€è¯»é”ï¼ˆå…±äº«é”ï¼‰
### è‡ªæ—‹é”SpinLock
### æ— é”->ç‹¬å é”->è¯»å†™é” ->é‚®æˆ³é”
### æ— é”->åå‘é”->è½»é‡çº§é”->é‡é‡çº§é”
## LockSupportä¸çº¿ç¨‹ä¸­æ–­

### çº¿ç¨‹ä¸­æ–­æœºåˆ¶â—â—

#### èš‚èšé‡‘æœé¢è¯•é¢˜

1. å¦‚ä½•ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹
2. å¦‚ä½•åœæ­¢ä¸€ä¸ªçº¿ç¨‹
3. `interrupt()`  `interrupted()` ` isInterrupted()`ä¸‰ä¸ªæ–¹æ³•çš„åŒºåˆ«

#### ä»€ä¹ˆæ˜¯ä¸­æ–­æœºåˆ¶

ä¸­æ–­åªæ˜¯ä¸€ç§åå•†æœºåˆ¶ï¼ŒJavaæ²¡æœ‰ç»™ä¸­æ–­å®ç°ä»»ä½•çš„æ–¹æ³•ï¼Œå…·ä½“çš„ä¸­æ–­è¿‡ç¨‹éœ€è¦å¼€å‘è€…è‡ªå·±å®ç°ã€‚å¦‚æœéœ€è¦ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨è¯¥çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œ<font color="red">interruptæ–¹æ³•ä»…ä»…æ˜¯å°†çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½è®¾ç½®ä¸ºtrueï¼Œ</font>å¹¶æ²¡æœ‰å®é™…ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼€å‘è€…éœ€è¦è‡ªå·±å†™ä»£ç ä¸æ–­åœ°æ£€æµ‹ä¸­æ–­æ ‡å¿—ä½ï¼Œå¦‚æœä¸ºtrueè¡¨ç¤ºæœ‰çº¿ç¨‹è¯·æ±‚å½“å‰çº¿ç¨‹ä¸­æ–­ï¼Œå‰©ä¸‹çš„ä¸­æ–­é€»è¾‘éœ€è¦è‡ªå·±å»å®ç°ã€‚

#### ä¸­æ–­ç›¸å…³APIè¯´æ˜

| æ–¹æ³•                           | æ–¹æ³•è¯´æ˜                                                     |
| ------------------------------ | ------------------------------------------------------------ |
| Public void  interrupt()       | interruptæ–¹æ³•ä»…ä»…æ˜¯çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€è®¾ç½®ä¸ºtrueï¼Œå‘èµ·ä¸€ä¸ªåå•†è€Œä¸ä¼šç«‹åˆ»åœæ­¢çº¿ç¨‹ |
| public boolean isInterrupted() | é€šè¿‡æ£€æŸ¥ä¸­æ–­æ ‡å¿—ä½æ¥åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­                   |

#### å¤§å‚ä¸­æ–­é¢è¯•é¢˜

1. å¦‚ä½•ä¸­æ–­æ­£åœ¨è¿è¡Œä¸­çš„çº¿ç¨‹
   1. é€šè¿‡ä¸€ä¸ªvolatileå˜é‡å®ç°

      ```java
      public class InterruptDemo {
          /**
           * çº¿ç¨‹ä¸­æ–­çŠ¶æ€
           */
          private static volatile boolean isStop = false;
          public static void main(String[] args) throws InterruptedException {
              new Thread(() ->{
                  while (true) {
                      if(isStop) {
                          System.out.println(Thread.currentThread().getName() + " isStop è¢«ä¿®æ”¹ä¸ºtrueï¼Œçº¿ç¨‹ç»ˆæ­¢");
                          break;
                      }
                      System.out.println(Thread.currentThread().getName() + " hello volatile");
                  }
              }, "thread1").start();
      
              TimeUnit.SECONDS.sleep(1);
      
              new Thread(() -> {
                  isStop = true;
                  System.out.println(Thread.currentThread().getName() + " å°†çº¿ç¨‹1ä¸­æ–­çŠ¶æ€ä¿®æ”¹ä¸ºtrue");
              }, "thread2").start();
          }
      }

   2. é€šè¿‡AtomicBooleanå˜é‡å®ç°

   3. é€šè¿‡Threadç±»è‡ªå¸¦çš„ä¸­æ–­apiå®ä¾‹æ–¹æ³•å®ç°

      ```java
      private static void fun2() throws InterruptedException {
        Thread thread1 = new Thread(() -> {
          while (true) {
            if (Thread.currentThread().isInterrupted()) {
              System.out.println(Thread.currentThread().getName() + " isInterrupt è¢«ä¿®æ”¹ä¸ºtrueï¼Œçº¿ç¨‹ç»ˆæ­¢");
              break;
            }
            System.out.println(Thread.currentThread().getName() + " hello interrupt");
          }
        }, "thread1");
        thread1.start();
      
        TimeUnit.SECONDS.sleep(1);
      
        new Thread(() -> {
          thread1.interrupt();
          System.out.println(Thread.currentThread().getName() + " å°†çº¿ç¨‹1ä¸­æ–­çŠ¶æ€ä¿®æ”¹ä¸ºtrue");
        }, "thread2").start();
      }
      ```

2. å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¸ºtrueï¼Œæ˜¯ä¸æ˜¯çº¿ç¨‹å°±ç«‹åˆ»åœæ­¢äº†ï¼Ÿ

   ä»…ä»…æ˜¯å°†çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½è®¾ç½®ä¸ºtrueï¼Œä¸ä¼šç«‹åˆ»åœæ­¢çº¿ç¨‹ã€‚<font color="red">å¹¶ä¸”ä¸­æ–­ä¸æ´»åŠ¨çš„çº¿ç¨‹ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚</font>

   å¦‚æœçº¿ç¨‹å¤„äºè¢«é˜»å¡çŠ¶æ€ï¼ˆsleepã€waitã€joinçŠ¶æ€ï¼‰ï¼Œå½“åˆ«çš„çº¿ç¨‹è°ƒç”¨è¯¥çº¿ç¨‹çš„interruptæ–¹æ³•æ—¶ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ç«‹åˆ»é€€å‡ºé˜»å¡çŠ¶æ€ï¼Œ<font color="red">å¹¶ä¸”è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½è¢«æ¸…ç©ºï¼ˆéœ€è¦åœ¨catchä»£ç å—ä¸­å†æ¬¡è°ƒç”¨interruptæ–¹æ³•æ‰èƒ½é‡æ–°è®¾ç½®ä¸­æ–­æ ‡å¿—ä½ï¼‰ï¼Œç¨‹åºç»§ç»­è¿è¡Œï¼Œ</font>å¹¶ä¸”æŠ›å‡ºä¸€ä¸ªInterruptExceptionå¼‚å¸¸ã€‚

3. é™æ€æ–¹æ³•`Thread.interrupted()`ï¼Œè°ˆè°ˆä½ çš„ç†è§£

   1. è¿”å›å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€
   2. å°†å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€æ¸…é›¶ï¼Œå¹¶ä¸”é‡æ–°è®¾ç½®ä¸ºfalse


â€‹		  <font color="red">è¿ç»­ä¸¤æ¬¡è°ƒç”¨è¯¥æ–¹æ³•è¿”å›çš„ç»“æœæœ‰å¯èƒ½ä¸ä¸€æ ·ã€‚</font>

#### æ€»ç»“

### LockSupportæ˜¯ä»€ä¹ˆï¼Ÿ

LockSupportæ˜¯ä¸€ä¸ªçº¿ç¨‹é˜»å¡å·¥å…·ç±»ï¼Œ`park`æ–¹æ³•å¯ä»¥é˜»å¡çº¿ç¨‹ï¼Œ`unpark`æ–¹æ³•å¯ä»¥è§£é™¤é˜»å¡çš„çº¿ç¨‹ã€‚è§£é™¤é˜»å¡çš„çº¿ç¨‹éœ€è¦æ¶ˆè€—å‡­è¯ï¼ˆpermitï¼‰è¿™ä¸ªå‡­è¯æœ€å¤šåªæœ‰ä¸€ä¸ªã€‚

### çº¿ç¨‹ç­‰å¾…å”¤é†’æœºåˆ¶â—â—

#### ä¸‰ç§è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’çŠ¶æ€çš„æ–¹æ³•

1. Objectç±»çš„waitå’Œnotifyæ–¹æ³•å®ç°ç­‰å¾…å”¤é†’æœºåˆ¶
2. Conditionæ¥å£çš„awaitå’Œsingalæ–¹å¼å®ç°ç­‰å¾…å”¤é†’æœºåˆ¶
3. LockSuopportç±»çš„parkæ–¹æ³•å¯ä»¥é˜»å¡å½“å‰çº¿ç¨‹ã€unparkæ–¹æ³•å¯ä»¥å”¤é†’æŒ‡å®šè¢«é˜»å¡çš„çº¿ç¨‹

#### Objectç±»çš„waitå’Œnotifyæ–¹æ³•å®ç°ç­‰å¾…å”¤é†’æœºåˆ¶

```java
private static void fun1() {
  Object lock = new Object();
  new Thread(() -> {
    try {
      TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
      throw new RuntimeException(e);
    }
    synchronized (lock) {
      System.out.println(Thread.currentThread().getName() + " come in");
      try {
        lock.wait();
      } catch (InterruptedException e) {
        throw new RuntimeException(e);
      }
      System.out.println(Thread.currentThread().getName() + " è¢«å”¤é†’");
    }
  }, "thread1").start();


  new Thread(() -> {
    synchronized (lock) {
      lock.notify();
      System.out.println(Thread.currentThread().getName() + " å‘å‡ºé€šçŸ¥");
    }
  }, "thread2").start();
}
```

##### ä½¿ç”¨æ³¨æ„äº‹é¡¹  

1. waitå’Œnotifyæ–¹æ³•å¿…é¡»åœ¨åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•å†…ä½¿ç”¨ï¼ˆå¿…é¡»å…ˆæŒæœ‰é”ï¼‰ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸
2. å¿…é¡»å…ˆè°ƒç”¨waitæ–¹æ³•ï¼Œå†è°ƒç”¨notifyæ–¹æ³•ï¼Œå¦åˆ™ä¼šå‡ºç°ç¨‹åºé˜»å¡æƒ…å†µ

#### Conditionæ¥å£çš„awaitå’Œsingleæ–¹å¼å®ç°ç­‰å¾…å”¤é†’æœºåˆ¶

```java
private static void fun2() throws InterruptedException {
  Lock lock = new ReentrantLock();
  Condition condition = lock.newCondition();
  new Thread(() -> {
    lock.lock();
    try {
      System.out.println(Thread.currentThread().getName() + " come in");
      condition.await();
      System.out.println(Thread.currentThread().getName() + " è¢«å”¤é†’");
    } catch (Exception e) {
      throw new RuntimeException(e);
    } finally {
      lock.unlock();
    }
  }, "thread1").start();

  TimeUnit.SECONDS.sleep(3);
  new Thread(() -> {
    lock.lock();
    try {
      condition.signal();
      System.out.println(Thread.currentThread().getName() + " å‘å‡ºé€šçŸ¥");
    } catch (Exception e) {
      throw new RuntimeException(e);
    } finally {
      lock.unlock();
    }
  }, "thread2").start();
}
```

##### ä½¿ç”¨æ³¨æ„äº‹é¡¹

1. awaitæ–¹æ³•å’Œsignalæ–¹æ³•å¿…é¡»å…ˆæŒæœ‰é”æ‰èƒ½è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸
2. å¿…é¡»å…ˆè°ƒç”¨awaitæ–¹æ³•å†è°ƒç”¨signalæ–¹æ³•ï¼Œå¦åˆ™çº¿ç¨‹ä¼šé˜»å¡

#### ä¸Šè¿°ä¸¤ä¸ªObjectå’ŒConditionå¯¹è±¡çš„ä½¿ç”¨é™åˆ¶

#### LockSuopportç±»çš„parkå’Œunparkå®ç°ç­‰å¾…å”¤é†’æœºåˆ¶

LockSupportæ˜¯ä¸€ä¸ªçº¿ç¨‹é˜»å¡å·¥å…·ç±»ï¼Œ`park`æ–¹æ³•å¯ä»¥é˜»å¡çº¿ç¨‹ï¼Œ`unpark`æ–¹æ³•å¯ä»¥è§£é™¤é˜»å¡çš„çº¿ç¨‹ã€‚

```java
private static void fun3() throws InterruptedException {
  Thread thread1 = new Thread(() -> {
    System.out.println(Thread.currentThread().getName() + " come in");
    LockSupport.park();
    System.out.println(Thread.currentThread().getName() + " è¢«å”¤é†’");
  }, "thread1");
  thread1.start();

  TimeUnit.SECONDS.sleep(3);

  new Thread(() -> {
    LockSupport.unpark(thread1);
    System.out.println(Thread.currentThread().getName() + " å‘å‡ºé€šçŸ¥");
  }, "thread2").start();
}
```

##### LockSupportä½¿ç”¨æ³¨æ„äº‹é¡¹

1. <font color="red">çº¿ç¨‹ä¸éœ€è¦æŒæœ‰é”å°±å¯ä»¥ç›´æ¥è°ƒç”¨parkã€unparkæ–¹æ³•</font>
2. <font color="red">å¯ä»¥å…ˆè°ƒç”¨unparkæ–¹æ³•å”¤é†’çº¿ç¨‹ï¼Œå†è°ƒç”¨parkæ–¹æ³•é˜»å¡çº¿ç¨‹ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹æœ€ç»ˆè¿˜æ˜¯å¯ä»¥è¢«å”¤é†’ã€‚</font> 
3. å½“è°ƒç”¨parkæ–¹æ³•æ—¶ï¼Œå¦‚æœæœ‰å‡­è¯åˆ™ä¼šç›´æ¥æ¶ˆè€—æ‰è¿™ä¸ªå‡­è¯ï¼Œçº¿ç¨‹é€€å‡ºé˜»å¡çŠ¶æ€ï¼›å¦‚æœæ²¡æœ‰å‡­è¯åˆ™çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€
4. å½“è°ƒç”¨unparkæ—¶ï¼Œ<font color="red">å®ƒä¼šå¢åŠ ä¸€ä¸ªå‡­è¯ï¼Œä½†æ˜¯å‡­è¯åªèƒ½æœ‰ä¸€ä¸ªç´¯åŠ æ— æ•ˆã€‚</font>

##### LockSupporté¢è¯•é¢˜

1. ä¸ºä»€ä¹ˆLockSupportå¯ä»¥çªç ´wait/notifyåŸæœ‰çš„è°ƒç”¨é¡ºåºï¼Ÿ

   å› ä¸ºé€šè¿‡unparkæ–¹æ³•å¯ä»¥è·å–ä¸€ä¸ªå‡­è¯ï¼Œä¹‹åå†è°ƒç”¨parkæ–¹æ³•å¯ä»¥æ¶ˆè´¹è¿™ä¸ªå‡­è¯ï¼Œç¨‹åºä¸ä¼šé˜»å¡

2. ä¸ºä»€ä¹ˆé˜»å¡ä¸¤æ¬¡ä¹‹åå†å”¤é†’ä¸¤æ¬¡ï¼Œæœ€ç»ˆçº¿ç¨‹è¿˜æ˜¯å¤„äºé˜»å¡çŠ¶æ€ï¼Ÿ

   å› ä¸ºé‡å¤è°ƒç”¨unparkæ–¹æ³•åªä¼šç”Ÿäº§ä¸€ä¸ªå‡­è¯ï¼Œè°ƒç”¨ä¸¤æ¬¡parkæ–¹æ³•éœ€è¦æ¶ˆè´¹ä¸¤ä¸ªå‡­è¯ï¼Œå› æ­¤çº¿ç¨‹è¿˜æ˜¯å¤„äºé˜»å¡çŠ¶æ€

## Javaå†…å­˜æ¨¡å‹ä¹‹JMM

### å¤§å‚é¢è¯•é¢˜

1. ä»€ä¹ˆæ˜¯Javaå†…å­˜æ¨¡å‹

2. JMMå’Œvolatileä¹‹é—´çš„å…³ç³»

3. JMMçš„ä¸‰å¤§ç‰¹æ€§

   JMMçš„å…³é”®æŠ€æœ¯éƒ½æ˜¯å›´ç»•ç€å¤šçº¿ç¨‹çš„åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§å±•å¼€çš„ã€‚

4. ä¸ºä»€ä¹ˆè¦æœ‰JMMï¼Œå®ƒçš„ä½œç”¨å’ŒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

   1. é€šè¿‡JMMå¯ä»¥å®ç°çº¿ç¨‹å’Œä¸»å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»
   2. å±è”½å„ä¸ªç¡¬ä»¶å¹³å°å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚

5. happens-beforeåŸåˆ™çš„ç†è§£ï¼Ÿ

### è®¡ç®—æœºç¡¬ä»¶å­˜å‚¨ä½“ç³»

CPUçš„è¿è¡Œä¸æ˜¯ç›´æ¥æ“ä½œçš„å†…å­˜çš„ï¼Œè€Œæ˜¯å…ˆæŠŠå†…å­˜çš„æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå†…å­˜å’Œç¼“å­˜ï¼Ÿï¼‰

JMMçš„ä½œç”¨æ˜¯å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå†…å­˜è®¿é—®çš„å·®å¼‚ã€‚

### Java Memory Model

### JMMä¸‰å¤§ç‰¹æ€§

1. å¯è§æ€§

   æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸€ä¸ªå…±äº«å˜é‡ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¦ç«‹åˆ»çŸ¥é“å…±äº«å˜é‡çš„å˜æ›´ã€‚çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡çš„è®¿é—®æ˜¯é€šè¿‡è®¿é—®ä¸»å­˜æ¥å®ç°çš„ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´ä¸èƒ½ç›´æ¥è®¿é—®å¯¹æ–¹çš„ç§æœ‰å·¥ä½œå†…å­˜ã€‚

   <img src="https://s3.bmp.ovh/imgs/2022/08/17/84db4fc22e541a18.png" style="zoom: 33%;" />

2. æœ‰åºæ€§

   ä¸ºäº†æé«˜ç¨‹åºæ€§èƒ½ï¼Œç¼–è¾‘å™¨å’Œå¤„ç†å™¨é€šå¸¸ä¼šå¯¹æŒ‡ä»¤çš„æ‰§è¡Œé‡æ–°æ’åºï¼ŒæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºå’Œä»£ç çš„é¡ºåºä¸ä¸€è‡´å°±å«åšæŒ‡ä»¤çš„é‡æ’åºã€‚

   å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¤šä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’åºçš„å­˜åœ¨ï¼Œå¤šä¸ªçº¿ç¨‹ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ã€‚

   <font color="red">å› æ­¤å¤„ç†å™¨åœ¨è¿›è¡ŒæŒ‡ä»¤é‡æ’åºçš„è¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘æ•°æ®ä¾èµ–æ€§ï¼Œåœ¨æŸäº›åœºæ™¯ä¸­JMMéœ€è¦ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œä¿è¯ç¨‹åºçš„æœ‰åºæ€§ã€‚</font>

3. åŸå­æ€§

   æŒ‡çš„æ˜¯ä¸€ä¸ªæ“ä½œæ˜¯ä¸èƒ½è¢«æ‰“æ–­çš„ï¼Œå³ä½¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°

### JMMè§„èŒƒä¸‹ï¼Œå¤šçº¿ç¨‹å¯¹å˜é‡çš„è¯»å†™è¿‡ç¨‹



### happens-beforeåŸåˆ™

åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»è¦å­˜åœ¨happens-beforeå…³ç³»ã€‚ä¸¤ä¸ªæ“ä½œä¹‹é—´å…·æœ‰happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€å‰ä¸€ä¸ªæ“ä½œå¿…é¡»è¦åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰æ‰§è¡Œï¼happens-beforeä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ã€‚

## Volatileä¸JMM

### Volatileç‰¹ç‚¹

#### ç‰¹ç‚¹

1. å¯è§æ€§

2. æœ‰åºæ€§

    å¦‚æœä¸¤ä¸ªæŒ‡ä»¤å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œvolatileä¼šç¦æ­¢æŒ‡ä»¤é‡æ’

#### volatileå†…å­˜è¯­ä¹‰

å½“å†™ä¸€ä¸ªvolatileå…±äº«å˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜çš„å…±äº«å˜é‡çš„å€¼åˆ·æ–°å›ä¸»å†…å­˜ï¼›

å½“è¯»ä¸€ä¸ªvolatileå…±äº«å˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜çš„å€¼è®¾ç½®ä¸ºæ— æ•ˆï¼Œ é‡æ–°ä»å…±äº«å†…å­˜ä¸­è¯»å–æœ€æ–°çš„å€¼ã€‚

æ‰€ä»¥volatileçš„å†™å†…å­˜è¯­ä¹‰æ—¶ç›´æ¥åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼›è¯»å†…å­˜è¯­ä¹‰æ˜¯ç›´æ¥ä»ä¸»å†…å­˜ä¸­è¯»å–ã€‚

#### volatileä¸ºä»€ä¹ˆå¯ä»¥ä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ï¼Ÿ

åº•å±‚é€šè¿‡å†…å­˜å±éšœå®ç°çš„

### å†…å­˜å±éšœâ—â—

#### å†…å­˜å±éšœæ¦‚å¿µ

å†…å­˜å±éšœï¼Œæ˜¯ä¸€ç±»åŒæ­¥å±éšœæŒ‡ä»¤ï¼Œæ˜¯CPUæˆ–è€…ç¼–è¯‘å™¨å¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œçš„ä¸€éƒ¨åŒæ­¥ç‚¹ï¼Œä½¿å¾—æ¬¡åŒæ­¥ç‚¹ä¹‹å‰çš„æ‰€æœ‰çš„è¯»å†™æ“ä½œæ‰§è¡Œå®Œä¹‹åæ‰èƒ½æ‰§è¡ŒåŒæ­¥ç‚¹ä¹‹åçš„æ“ä½œï¼Œ<font color="red">ç›®çš„æ˜¯ä¸ºäº†é¿å…ä»£ç é‡æ’åºã€‚</font>

#### å†…å­˜å±éšœåˆ†ç±»

ä¸¤å¤§ç±»

1. è¯»å±éšœ

   åœ¨è¯»ä¹‹ä»¤ä¹‹å‰æ’å…¥è¯»å±éšœï¼Œè®©å·¥ä½œå†…å­˜ä¸­çš„ç¼“å­˜æ•°æ®å¤±æ•ˆï¼Œé‡æ–°åˆ°ä¸»å†…å­˜ä¸­è·å–æœ€æ–°çš„æ•°æ®

2. å†™å±éšœ

    åœ¨å†™æŒ‡ä»¤ä¹‹å‰æ’å…¥å†™å±éšœï¼Œå¼ºåˆ¶æŠŠå·¥ä½œå†…å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­

å››å°ç±»

| å±éšœç±»å‹   | æŒ‡ä»¤ç¤ºä¾‹                 | è¯´æ˜                                                         |
| ---------- | ------------------------ | ------------------------------------------------------------ |
| LoadLoad   | Load1; LoadLoad;Load2    | ä¿è¯Load1è¯»æ“ä½œåœ¨Load2åŠå…¶åç»­çš„è¯»æ“ä½œä¹‹å‰æ‰§è¡Œ               |
| StoreStore | Store1;StoreStore;Store2 | åœ¨Store2åŠå…¶åç»­çš„å†™æ“ä½œæ‰§è¡Œä¹‹å‰ï¼Œä¿è¯Store1çš„å†™æ“ä½œå·²ç»åˆ·æ–°å›ä¸»å†…å­˜ |
| LoadStore  | Load1; LoadStore;Store2  | åœ¨Store2åŠå…¶åçš„å†™æ“ä½œæ‰§è¡Œæ‰§è¡Œä¹‹å‰ï¼Œä¿è¯load1çš„è¯»æ“ä½œå·²ç»æ‰§è¡Œç»“æŸ |
| StoreLoad  | Store1;StoreLoad;Load2   | ä¿è¯Store1çš„å†™æ“ä½œå·²ç»åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹åï¼ŒLoad2çš„è¯»æ“ä½œæ‰å¯ä»¥æ‰§è¡Œ |

### Volatileç‰¹æ€§

#### ä¿è¯å¯è§æ€§

ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡å®Œæˆå†™æ“ä½œä¹‹åï¼Œç»“æœç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚

```java
public class VolatileDemo {
    static volatile boolean flag = true;
    public static void main(String[] args) throws InterruptedException {
        new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + " come in");
            while (flag) {

            }
            System.out.println(Thread.currentThread().getName() + "flag è¢«è®¾ç½®ä¸º:" + flag + " come out");
        },"thread1").start();

        TimeUnit.SECONDS.sleep(3);
        flag = false;
        System.out.println(Thread.currentThread().getName() + "æŠŠflagè¢«è®¾ç½®ä¸º:" + flag);
    }
}
```

#### æ²¡æœ‰åŸå­æ€§

<font color="red">åŸå­æ€§æŒ‡çš„æ˜¯ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œå³ä½¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦æ‰§è¡Œä¸ä¼šå—å…¶ä»–çº¿ç¨‹å½±å“ã€‚volatileå…³é”®å­—ä¸èƒ½ä¿è¯åŸå­æ€§ã€‚</font>

```java
class NumberClass {
    public int number;
    public synchronized void add() {
        // 1.åŠ è½½å–å€¼
        // 2.åŠ 1æ“ä½œ
        // 3.èµ‹å€¼
        number ++;
    }
}

public class VolatileDemo2 {
    public static void main(String[] args) throws InterruptedException {
        NumberClass numberClass = new NumberClass();
        for (int i = 0; i < 100; i++) {
            new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                     numberClass.add();
                }
            }).start();
        }
        TimeUnit.SECONDS.sleep(2);
        System.out.println(numberClass.number);
    }
}
```

`i ++ `ï¼ˆvolatileä¿®é¥°è¿™ä¸ªå˜é‡ï¼‰æ“ä½œä¸å…·å¤‡åŸå­æ€§ã€‚è¯¥æ“ä½œåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šè¯»å–æ—§å€¼ã€åŠ ä¸€æ“ä½œã€èµ‹æ–°å€¼ã€‚å¦‚æœç¬¬äºŒä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹è¯»å–æ—§å€¼å’Œèµ‹æ–°å€¼æœŸé—´è¯»å–çš„å˜é‡ï¼Œé‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹è¯»å–çš„æ˜¯åŒä¸€ä¸ªå€¼ï¼Œæœ€ç»ˆæ‰§è¡Œäº†ç›¸åŒå€¼çš„åŠ ä¸€æ“ä½œï¼Œæœ€ç»ˆå‡ºç°äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å› æ­¤addæ–¹æ³•å¿…é¡»ä½¿ç”¨`synchronied`å…³é”®å­—æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

#### ç¦æ­¢æŒ‡ä»¤é‡æ’

volatileæŒ‡ä»¤åº•å±‚é€šè¿‡å†…å­˜å±éšœå¯ä»¥å®ç°ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚

### å¦‚ä½•æ­£ç¡®åœ°ä½¿ç”¨Volatile

#### å•ä¸€èµ‹å€¼å¯ä»¥ï¼Œä½†æ˜¯å¤åˆè¿ç®—èµ‹å€¼ä¸å¯ä»¥ï¼ˆi++ï¼‰

```java
// å•ä¸€èµ‹å€¼åœºæ™¯
volatile int a = 10;
volatile boolean flag = false;
```

#### ä½œä¸ºçŠ¶æ€æ ‡å¿—ï¼Œåˆ¤æ–­ä¸šåŠ¡æ˜¯å¦ç»“æŸ

```java
/**
 * ä½¿ç”¨ï¼šä½œä¸ºçŠ¶æ€æ ‡å¿—ï¼Œåˆ¤æ–­ä¸šåŠ¡æ˜¯å¦æ­£å¸¸ç»“æŸ
 * ç†ç”±ï¼šçŠ¶æ€æ ‡å¿—ä¸ä¾èµ–äºç¨‹åºå†…çš„å…¶ä»–çŠ¶æ€ï¼Œä¸”é€šå¸¸åªæœ‰ä¸€ç§çŠ¶æ€è½¬æ¢
 */
public class VolatileDemo {
    private static volatile boolean flag = true;
    public static void main(String[] args) throws InterruptedException {
        new Thread(() -> {
            while (flag) {
                // do something
            }
        },"thread1").start();

        TimeUnit.SECONDS.sleep(3);

         new Thread(() -> {
             flag = false;
         }, "thread2").start();
    }
}
```

#### è¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œçš„åœºæ™¯

```java
public class VolatileCounterDemo {
     private volatile int value;

     /**
      * volatileå¯ä»¥ä¿è¯è¯»æ“ä½œçš„å¯è§æ€§
      * @return
      */
     public int getValue (){
          return value;
     }

     /**
      * åˆ©ç”¨synchronizedå¯ä»¥ä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§
      * @return
      */
     public synchronized int increment() {
          return value ++;
     }
}
```

#### DCLåŒç«¯é”å®ç°

åˆå§‹åŒ–å¯¹è±¡çš„æ“ä½œå†…éƒ¨åˆ†ä¸ºä¸‰æ­¥è¿›è¡Œï¼š1.åˆ†é…å†…å­˜ç©ºé—´ã€2.åˆå§‹åŒ–å¯¹è±¡ã€3.å°†å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´

<font color="red">åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç”±äºæŒ‡ä»¤é‡æ’åºï¼Œå°†å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´å…ˆäºåˆå§‹åŒ–å¯¹è±¡æ‰§è¡Œï¼Œæ‰€ä»¥å¯èƒ½è¿”å›NULLï¼Œé€šè¿‡volatileå…³é”®å­—å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚</font>

```java
public class SafeDoubleCheckSingleton {

    private static volatile SafeDoubleCheckSingleton instance;
    // ç§æœ‰åŒ–æ„é€ å‚æ•°
    private SafeDoubleCheckSingleton (){}

    // åŒé‡æ£€æŸ¥é”è®¾è®¡
    public SafeDoubleCheckSingleton getInstance() {
        if (instance == null) {
            // å¤šçº¿ç¨‹åˆ›å»ºå¯¹è±¡æ—¶ï¼Œé€šè¿‡åŠ é”å¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå¯¹è±¡
            synchronized (SafeDoubleCheckSingleton.class) {
                if (instance == null) {
                    //instance = new SafeDoubleCheckSingleton();è¿™è¡Œåˆå§‹åŒ–å¯¹è±¡ä»£ç å†…éƒ¨åšäº†ä¸‰ä»¶äº‹æƒ…
                    // 1.åˆ†é…å†…å­˜ç©ºé—´
                    // 2.åˆå§‹åŒ–å¯¹è±¡
                    // 3.
                    instance = new SafeDoubleCheckSingleton();
                }
            }
        }
        // å¯¹è±¡åˆ›å»ºå®Œæ¯•ä¹‹åï¼Œå†æ¬¡è°ƒç”¨getInstanceæ–¹æ³•å¯ä»¥ä¸éœ€è¦åŠ é”ç›´æ¥è¿”å›å¯¹è±¡
        return instance;
    }
}
```

### Volatileä½¿ç”¨å°ç»“

1. ä¿è¯å¯è§æ€§
2. æ²¡æœ‰åŸå­æ€§
3.  volatileå¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’
4.  å†…å­˜å±éšœæ˜¯ä»€ä¹ˆï¼Ÿ
   1. è¯»å±éšœ
   2. å†™å±éšœ
5. å†…å­˜å±éšœçš„ä½œç”¨
6. å†…å­˜å±éšœçš„å››å¤§æŒ‡ä»¤

## CASåŸç†

### åŸå­ç±»

jucåŒ…ä¸­çš„Atomicç±»éƒ½æ˜¯åŸå­ç±»

### æ²¡æœ‰CASä¹‹å‰

å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä½¿ç”¨åŸå­ç±»ä¿è¯i++çš„çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨synchronizedåŠ é”çš„æ–¹å¼ä¿è¯åŸå­æ“ä½œï¼‰

```java
public class CASDemo1 {
    private volatile static int num;

    // volatileå¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§
    public int getNum() {
        return num;
    }

    // synchronizedåŒæ­¥æ–¹æ³•å¯ä»¥ä¿è¯i++ æ“ä½œçš„åŸå­æ€§ã€çº¿ç¨‹å®‰å…¨ï¼ˆä¸è¿‡åŒæ­¥é”å¤ªé‡é‡çº§äº†ï¼‰
    public synchronized void setNum() {
        num++;
    }
}
```

### ä½¿ç”¨CASä¹‹å

å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨åŸå­ç±»ä¿è¯i++çš„çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨åŸå­ç±»æ¥ä¿è¯åŸå­æ“ä½œï¼‰

```java
private AtomicInteger atomicInteger = new AtomicInteger();

public int getNum() {
  return atomicInteger.get();
}

public void setNum() {
  atomicInteger.getAndIncrement();
}
```

### CASæ˜¯ä»€ä¹ˆ

Compare And Setå³CASï¼Œä¸­æ–‡æ„æ€æ˜¯æ¯”è¾ƒå¹¶äº¤æ¢ã€‚åœ¨CASæ“ä½œä¸­æœ‰ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯å†…å­˜ä¸­çš„å€¼Vã€æ—§çš„é¢„æœŸå€¼Aã€è¦ä¿®æ”¹çš„æ–°å€¼Bã€‚CASæ“ä½œè¿‡ç¨‹ä¸ºï¼šå¦‚æœå†…å­˜ä¸­çš„å€¼Vå’Œæ—§çš„é¢„æœŸå€¼Aç›¸ç­‰åˆ™å°†å†…å­˜ä¸­çš„å€¼Aä¿®æ”¹ä¸ºæ–°å€¼Bï¼Œå¦åˆ™å¾ªç¯é‡è¯•ã€‚

### CASåº•å±‚åŸç†ğŸ˜¬ğŸ˜¬ğŸ˜¬ğŸ˜¬ğŸ˜¬

### åŸå­å¼•ç”¨

### CASä¸è‡ªæ—‹é”

CASæ˜¯å®ç°è‡ªæ—‹é”çš„åŸºç¡€ï¼ŒCASåº•å±‚åˆ©ç”¨äº†CPUæŒ‡ä»¤ä¿è¯äº†æ“ä½œçš„åŸå­æ€§ï¼Œä»¥è¾¾åˆ°é”çš„æ•ˆæœã€‚

è‡ªæ—‹é”ï¼šæ˜¯æŒ‡æœªè·å–åˆ°é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”èµ„æºï¼ŒçŸ¥é“è·å–åˆ°é”ä¸ºæ­¢ã€‚

è‡ªæ—‹é”ä¼˜ç¼ºç‚¹ï¼šå¯ä»¥å‡å°‘ä¸Šä¸‹ä¸ºåˆ‡æ¢çš„å¼€é”€ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUèµ„æºã€‚

```java
public class SpinLockDemo {
    AtomicReference<Thread> atomicReference = new AtomicReference<>();

    public void lock() {
        Thread currentThread = Thread.currentThread();
        System.out.println(currentThread.getName() + " come in");
        // CASæ“ä½œä¸æ˜¯å½“å‰çº¿ç¨‹åˆ™å¾ªç¯ç­‰å¾…
        while (!atomicReference.compareAndSet(null, currentThread)) {

        }
    }

    public void unLock() {
        Thread currentThread = Thread.currentThread();
        atomicReference.compareAndSet(currentThread, null);
        System.out.println(currentThread.getName() + " take out, unlock");
    }

    public static void main(String[] args) throws InterruptedException {
        SpinLockDemo spinLockDemo = new SpinLockDemo();
        new Thread(() -> {
            spinLockDemo.lock();
            try {
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            spinLockDemo.unLock();
        }, "A").start();

        // ç¡çœ 500æ¯«ç§’ï¼Œè®©Bçº¿ç¨‹æ™šäºAçº¿ç¨‹å¯åŠ¨
        TimeUnit.MILLISECONDS.sleep(500);

        new Thread(() -> {
            spinLockDemo.lock();
            spinLockDemo.unLock();
        }, "B").start();
    }
}
```

### CASç¼ºç‚¹

1. å¾ªç¯ä¼šå ç”¨å¤§é‡å¼€é”€

2.  CASä¼šå‘ç”ŸABAé—®é¢˜

   é€šè¿‡ç‰ˆæœ¬å·çš„æ–¹å¼å¯ä»¥è§£å†³ABAé—®é¢˜

   ```java
   public class AtomicStampDemo {
   
       public static void main(String[] args) {
           Book java = new Book(498401, "Java");
           AtomicStampedReference<Book> stampedReference = new AtomicStampedReference<>(java, 1);
           System.out.println(stampedReference.getStamp() + "\t " + stampedReference.getReference());
           Book mySQL = new Book(979129, "MySQL");
           boolean result = stampedReference.compareAndSet(java, mySQL, stampedReference.getStamp(), stampedReference.getStamp() + 1);
           System.out.println(stampedReference.getStamp() + "\t " + stampedReference.getReference() + " \t " +result);
   
           boolean result1 = stampedReference.compareAndSet(mySQL, java, stampedReference.getStamp(), stampedReference.getStamp() + 1);
           System.out.println(stampedReference.getStamp() + "\t " + stampedReference.getReference() + " \t " +result);
   
       }
   }
   ```

   ```log
   1	 Book{id=498401, name='Java'}
   2	 Book{id=979129, name='MySQL'} 	 true
   3	 Book{id=498401, name='Java'} 	 true
   ```

3. ABAé—®é¢˜å®æˆ˜

   **å…¸å‹çš„ABAé—®é¢˜**

   ```java
   public class ABADemo {
       static AtomicInteger atomicInteger = new AtomicInteger(100);
       public static void main(String[] args) {
           new Thread(() -> {
               atomicInteger.compareAndSet(100, 101);
               try {
                   // ç­‰å¾…20msï¼ŒæŠŠCPUèµ„æºè®©ç»™t2
                   System.out.println("1." + Thread.currentThread().getName() + " ç­‰å¾…20msï¼ŒæŠŠCPUèµ„æºè®©ç»™t2");
                   TimeUnit.MILLISECONDS.sleep(20);
               } catch (InterruptedException e) {
                   throw new RuntimeException(e);
               }
               System.out.println("4." + Thread.currentThread().getName() + " come in");
               atomicInteger.compareAndSet(101, 100);
           }, "t1").start();
   
           new Thread(() -> {
               System.out.println("2." + Thread.currentThread().getName() + " come in");
               try {
                   // t2çº¿ç¨‹ç¡çœ 200æ¯«ç§’ï¼Œè®©t1çº¿ç¨‹å®ŒæˆABAæ“ä½œ
                   System.out.println("3." + Thread.currentThread().getName() + " t2çº¿ç¨‹ç¡çœ 200æ¯«ç§’ï¼Œè®©t1çº¿ç¨‹å®ŒæˆABAæ“ä½œ");
                   TimeUnit.MILLISECONDS.sleep(200);
               } catch (InterruptedException e) {
                   throw new RuntimeException(e);
               }
               boolean result = atomicInteger.compareAndSet(100, 2022);
               System.out.println(result + " value: " + atomicInteger.get());
           }, "t2").start();
       }
   }
   ```

   ```java
   2.t2 come in
   3.t2 t2çº¿ç¨‹ç¡çœ 200æ¯«ç§’ï¼Œè®©t1çº¿ç¨‹å®ŒæˆABAæ“ä½œ
   1.t1 ç­‰å¾…20msï¼ŒæŠŠCPUèµ„æºè®©ç»™t2
   4.t1 come in
   true value: 2022
   ```

    **é€šè¿‡æ—¶é—´æˆ³çš„æ–¹å¼è§£å†³ABAé—®é¢˜**

   ```java
   public class ABADemo {
       static AtomicInteger atomicInteger = new AtomicInteger(100);
       static AtomicStampedReference<Integer> atomicStampedReference = new AtomicStampedReference<>(100,1);
       public static void main(String[] args) {
           new Thread(() -> {
               int firstStamp = atomicStampedReference.getStamp();
               System.out.println(Thread.currentThread().getName() + " é¦–æ¬¡ç‰ˆæœ¬å·ï¼š" + firstStamp);
               try {
                   // t3çº¿ç¨‹ç¡çœ 50msï¼Œä½¿t4çº¿ç¨‹è¿è¡Œ
                   TimeUnit.MILLISECONDS.sleep(50);
               } catch (InterruptedException e) {
                   throw new RuntimeException(e);
               }
               atomicStampedReference.compareAndSet(100, 101, atomicStampedReference.getStamp(), atomicStampedReference.getStamp() + 1);
               System.out.println(Thread.currentThread().getName() + " 2æ¬¡ç‰ˆæœ¬å·ï¼š" + atomicStampedReference.getStamp());
               atomicStampedReference.compareAndSet(101, 100, atomicStampedReference.getStamp(), atomicStampedReference.getStamp() + 1);
               System.out.println(Thread.currentThread().getName() + " 3æ¬¡ç‰ˆæœ¬å·ï¼š" + atomicStampedReference.getStamp());
           }, "t3").start();
   
           new Thread(() -> {
               int firstStamp = atomicStampedReference.getStamp();
               System.out.println(Thread.currentThread().getName() + " é¦–æ¬¡ç‰ˆæœ¬å·ï¼š" + firstStamp);
               try {
                   // t4çº¿ç¨‹ç¡çœ 100msï¼Œä½¿t3çº¿ç¨‹å®ŒæˆABAæ“ä½œ
                   TimeUnit.MILLISECONDS.sleep(100);
               } catch (InterruptedException e) {
                   throw new RuntimeException(e);
               }
               boolean casResult = atomicStampedReference.compareAndSet(100, 2022, firstStamp, firstStamp + 1);
               System.out.println("t4çº¿ç¨‹casç»“æœï¼š" + casResult + "\t" + atomicStampedReference.getReference() + "\t" + atomicStampedReference.getStamp());
           }, "t4").start();
       }
   }
   ```

   ```java
   t3 é¦–æ¬¡ç‰ˆæœ¬å·ï¼š1
   t4 é¦–æ¬¡ç‰ˆæœ¬å·ï¼š1
   t3 2æ¬¡ç‰ˆæœ¬å·ï¼š2
   t3 3æ¬¡ç‰ˆæœ¬å·ï¼š3
   t4çº¿ç¨‹casç»“æœï¼šfalse	100	3
   ```


## ThreadLocalğŸ˜¬ğŸ˜¬ğŸ˜¬ğŸ˜¬ğŸ˜¬

### ThreadLocalç®€ä»‹

#### å¤§å‚é¢è¯•é¢˜

1. ThreadLocalä¸­ThreadLocalMapçš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿå’ŒThreadLocalçš„å…³ç³»ï¼Ÿ
2. ThreadLocalçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ
3. ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜
4. ThreadLocalä¸­æœ€åä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•ï¼Ÿ

#### æ¦‚å¿µ

ThreadLocalæä¾›äº†ä¸€ä¸ªä¸“å±äºå„ä¸ªçº¿ç¨‹çš„ã€ç‹¬ç«‹çš„ã€æœ¬åœ°å˜é‡å‰¯æœ¬ã€‚

~~ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œè¿™äº›å˜é‡å’Œæ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡getã€setæ–¹æ³•ï¼‰<font color="red">éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚</font>~~

#### åº”ç”¨åœºæ™¯

ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„<font color="red">ç§æœ‰é™æ€å­—æ®µ</font>ï¼Œä½¿ç”¨ä»–ä»¬çš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆç”¨æˆ·IDã€äº‹åŠ¡IDï¼‰å’Œçº¿ç¨‹å…³è”èµ·æ¥ã€‚<font color="red">ThreadLocalä¸»è¦è§£å†³äº†è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œä»è€Œé¿å…çº¿å±‚å®‰å…¨é—®é¢˜ã€‚</font>

#### ~~APIä»‹ç»~~

#### å®æˆ˜

```java
public class ThreadLocalDemo {
    public static void main(String[] args) throws InterruptedException {
        House house = new House();
        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                try {
                    int  size = new Random().nextInt(5) + 1;
                    System.out.println(Thread.currentThread().getName() + "å–äº† " + size);
                    for (int j = 0; j < size; j++) {
                        house.sale();
                        house.saleByThreadLocal();
                    }
                } finally {
                    // åœ¨æœ€åçš„ä¸šåŠ¡é€»è¾‘ä¸­removeï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å†…å­˜æ³„æ¼çš„æƒ…å†µã€‚
                    house.threadLocal.remove();
                }
            }, String.valueOf(i)).start();
        }

        TimeUnit.SECONDS.sleep(1);

        System.out.println(Thread.currentThread().getName() + " ä¸€å…±å–äº†" + house.saleCount);
    }
}

class House{
    public int saleCount;
    // åˆå§‹åŒ–ThreadLocalå˜é‡
    public ThreadLocal<Integer> threadLocal = ThreadLocal.withInitial(() -> 0);
    public synchronized void sale() {
        saleCount++;
    }

    /**
     * æ¯ä¸ªçº¿ç¨‹å†…éƒ¨çš„å…±äº«å˜é‡å‰¯æœ¬+1
     */
    public void saleByThreadLocal() {
        threadLocal.set(1 + threadLocal.get());
    }
}
```

##### <font color="red">ä½¿ç”¨æ³¨æ„äº‹é¡¹</font>

1. ä½¿ç”¨ThreadLocaléœ€è¦åˆå§‹åŒ–è¯¥å˜é‡

2. å¿…é¡»å›æ”¶è‡ªå®šä¹‰çš„ThreadLocalå˜é‡

   å°¤å…¶æ˜¯åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹ä¼šè¢«ç»å¸¸ä½¿ç”¨ï¼Œå¦‚æœä¸åŠæ—¶æ¸…ç†è‡ªå®šä¹‰çš„ThreadLocalå˜é‡ï¼Œå¯èƒ½ä¼šå½±å“åç»­çš„ä¸šåŠ¡é€»è¾‘ã€å¯èƒ½è¿‡ä¼šå‡ºç°å†…å­˜æ³„æ¼çš„æƒ…å†µã€‚æ‰€ä»¥å°½é‡åœ¨try finallyä»£ç å—ä¸­å›æ”¶å˜é‡ã€‚

### ThreadLocalæºç åˆ†æ

#### Threadã€ThreadLocalã€ThreadLocal Mapå…³ç³»

### ThreadLocalå¯èƒ½é€ æˆçš„é—®é¢˜

#### ä¸šåŠ¡é€»è¾‘æ··ä¹±é—®é¢˜
ä»¥çº¿ç¨‹æ± çš„æ–¹å¼ä½¿ç”¨ThreadLocalã€‚å‘çº¿ç¨‹æ± çš„æäº¤çš„æ¯ä¸€ä¸ªä»»åŠ¡éƒ½åº”è¯¥åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œï¼Œçº¿ç¨‹æ¯æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡å°±åº”è¯¥å›åˆ°æœ€åˆçš„åˆå§‹çŠ¶æ€ï¼Œä¸åº”è¯¥å‡ºç°ä¸‹ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä¼šå—ä¸Šä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœå½±å“ã€‚å› æ­¤é€šè¿‡çº¿ç¨‹æ± çš„æ–¹å¼ä½¿ç”¨ThreadLocalå®Œæ¯•æ—¶éœ€è¦å›æ”¶è‡ªå®šä¹‰çš„ThreadLocalå˜é‡ï¼Œ<font color="red">å¦åˆ™å¯èƒ½ä¼šå‡ºç°å½±å“ä¸šåŠ¡é€»è¾‘æˆ–è€…å‡ºç°å†…å­˜æ³„æ¼çš„æƒ…å†µã€‚</font>

```java
public class ThreadLocalDemo2 {
    public static void main(String[] args) {
        MyData myData = new MyData();
        // åˆ›å»ºä¸€ä¸ªæœ‰ä¸‰ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
        ExecutorService executorService = Executors.newFixedThreadPool(3);
        try {
            // 10ä¸ªè¯·æ±‚ç”±3ä¸ªçº¿ç¨‹å¤„ç†
            for (int i = 0; i < 10; i++) {
                executorService.submit(() -> {
                        Integer beforeValue = myData.threadLocal.get();
                        myData.add();
                        Integer afterValue = myData.threadLocal.get();
                        System.out.println(Thread.currentThread().getName() + " before value: " + beforeValue + "\t" + "after value: " + afterValue);
                });
            }
        } finally {
            // å…³é—­çº¿ç¨‹æ± èµ„æº
            executorService.shutdown();
        }
    }
}

class MyData {
    public ThreadLocal<Integer> threadLocal = ThreadLocal.withInitial(() -> 0);

    public void add() {
        threadLocal.set(1 + threadLocal.get());
    }
}
```

*æ²¡æœ‰æ‰‹åŠ¨å›æ”¶ThreadLocalå˜é‡ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä¼šå—ä¸Šä¸€ä¸ªä»»åŠ¡çš„å½±å“ã€‚*

```java
pool-1-thread-3 before value: 0	after value: 1
pool-1-thread-1 before value: 0	after value: 1
pool-1-thread-2 before value: 0	after value: 1
pool-1-thread-1 before value: 1	after value: 2
pool-1-thread-1 before value: 2	after value: 3
pool-1-thread-1 before value: 3	after value: 4
pool-1-thread-2 before value: 1	after value: 2
pool-1-thread-2 before value: 2	after value: 3
pool-1-thread-3 before value: 1	after value: 2
pool-1-thread-1 before value: 4	after value: 5
```

------

```java
executorService.submit(() -> {
  try {
    Integer beforeValue = myData.threadLocal.get();
    myData.add();
    Integer afterValue = myData.threadLocal.get();
    System.out.println(Thread.currentThread().getName() + " before value: " + beforeValue + "\t" + "after value: " + afterValue);
  } finally {
    myData.threadLocal.remove();
  }
});
```

æ‰‹åŠ¨å›æ”¶äº†ThreadLocalå˜é‡ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œä¸åŒä»»åŠ¡çš„ç»“æœäº’ç›¸ç‹¬ç«‹ï¼Œä¸å—å½±å“ã€‚

```java
pool-1-thread-1 before value: 0	after value: 1
pool-1-thread-2 before value: 0	after value: 1
pool-1-thread-3 before value: 0	after value: 1
pool-1-thread-3 before value: 0	after value: 1
pool-1-thread-2 before value: 0	after value: 1
pool-1-thread-3 before value: 0	after value: 1
pool-1-thread-2 before value: 0	after value: 1
pool-1-thread-3 before value: 0	after value: 1
pool-1-thread-1 before value: 0	after value: 1
pool-1-thread-2 before value: 0	after value: 1
```

#### å†…å­˜æ³„æ¼é—®é¢˜

### æ€»ç»“

1.  ThreadLocalä½¿ç”¨ç†è§£

    æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å®ä¾‹å‰¯æœ¬ï¼Œå¹¶ä¸”åªç”±å½“å‰çº¿ç¨‹è‡ªå·±ä½¿ç”¨ï¼Œå…¶ä»–Theadä¸ä¼šè®¿é—®ï¼Œæ‰€ä»¥å°±ä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

## Javaå¯¹è±¡å†…å­˜å¸ƒå±€ä¸å¯¹è±¡å¤´

### å¯¹è±¡å†…å­˜å¸ƒå±€

å¯¹è±¡åœ¨å †å†…å­˜çš„å­˜å‚¨å¸ƒå±€å¯ä»¥åˆ’åˆ†ä¸ºï¼šå¯¹è±¡å¤´ï¼ˆHeaderï¼‰ã€å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰ã€å¯¹å…¶å¡«å……ï¼ˆPaddingï¼‰

<img src="https://s3.bmp.ovh/imgs/2022/09/01/fbec8a6b954cebdd.png" style="zoom: 33%;" />

#### å¯¹è±¡å¤´

1. å¯¹è±¡æ ‡è®°ï¼ˆMark Wordï¼‰

   é»˜è®¤å­˜å‚¨è¿™å¯¹è±¡çš„HashCodeã€åˆ†ä»£å¹´é¾„ã€é”æ ‡å¿—ä½ç­‰ä¿¡æ¯

2. ç±»å‹æŒ‡é’ˆï¼ˆClass Pointerï¼‰

   è™šæ‹Ÿæœºé€šè¿‡ç±»å‹æŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹

#### å®ä¾‹æ•°æ®

#### å¯¹é½å¡«å……

ä¿è¯å¯¹è±¡å¤§å°æ˜¯8ä¸ªå­—èŠ‚çš„å€æ•°











### <font color="red"></font>
