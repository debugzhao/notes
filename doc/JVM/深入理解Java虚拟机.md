# 深入理解Java虚拟机

## 第2章 Java内存区域与内存溢出异常

### 2.1概述

在Java程序中，内存管理机制由Java虚拟机负责管理，但是也正因为Java程序员把控制内存的权力交给了虚拟机，一旦出现<font color="red">内存泄漏</font>、<font color="red">内存溢出</font>等方面的问题，如果不了解虚拟机是怎么样使用内存的，那排查问题和修正问题将是非常艰难的工作。

本章节将会介绍Java虚拟机的各个区域，<font color="red">讲解这些区域的作用，服务的对象以及可能产生的问题</font>。

### 2.2 运行时数据区域

根据JVM规范，JVM所管理的内存区域将会包括以下几个运行时数据区域，它们分别是：

1. 方法区（线程共享数据区）
2. 堆内存（线程共享数据区）
3. 虚拟机栈（线程隔离数据区）
4. 本地方法栈（线程隔离数据区）
5. 程序计数器（线程隔离数据区）

<img src="https://cdn.jsdelivr.net/gh/Andre235/-community@master/src/image.2v4zu0awgmm0.webp" alt="image" style="zoom:67%;" />

#### 2.2.1 程序计数器

程序计数器是一块较小的内存空间，它可以看做是当前线程所执行的字节码的行号指示器。<font color="red">在Java虚拟机的概念模型中，字节码解释器工作时是需要改变这个计数器的值来确定下一条需要执行的字节码指令。</font>

由于Java虚拟机多线程的实现是通过多个线程轮流切换，抢占处理器执行时间来实现的。所以在任何一个时刻，任意一个处理器只能执行一个线程任务，因此线程切换后为了能够正确恢复到上一次执行任务的位置，线程内部需要程序计数器来保存当前执行位置。每个线程每部的程序计数器互相独立、互不影响。我们称这类内存区域为：<font color="red">线程私有内存区域</font>。

如果线程正在执行一个Java方法，则程序计数器保存的是当前正在执行的虚拟机字节码指令地址；如果线程执行的是本地（Native）方法，则程序计数器保存的值为空。

**程序计数器异常情况：**

<font color="red">程序计数器区域不会出现OutOfMemoryError情况。</font>

> Java虚拟机多线程实现原理：多个线程轮流切换，抢占处理器执行时间来实现的。

#### 2.2.2 Java虚拟机栈

<font color="red">与程序计数器一样，Java虚拟机栈也是线程私有的，它的生命周期和线程的生命周期相同。</font>虚拟机栈描述的是Java方法执行的线程内存模型：每个方法被执行时，Java虚拟机栈都会同步创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态链接、方法出口等信息。<font color="red">每个方法被调用直至执行完毕的过程，就对应着一个栈帧从入栈到出栈的过程。</font>

局部变量表存放着编译器可知的各种Java虚拟机基本数据类型、对象应用、返回地址。这种数据类型在局部变量表中的存储空间以`局部变量插槽`的形式表示。局部变量表所需要的内存空间在编译器就已经完成分配。当进入一个方法时，这个方法在栈帧中所需要的局部变量表空间是确定的，在方法执行期间也不会改变局部变量表的大小（这里的大小指的是插槽的数量）。

**虚拟机栈异常情况：**

1. StackOverflowError异常

   当线程请求的栈的深度超过虚拟机所允许的最大栈的深度，就会抛出StackOverflowError异常。

2. OutOfMemoryError异常

   当栈空间扩展无法申请到足够的内存时就会抛出OutOfMemoryError异常。

#### 2.2.3 本地方法栈

本地方法栈与虚拟机栈提供的作用是非常相似的，其区别就是虚拟机栈执行的是Java方法，本地方法栈执行的是本地Native方法。

#### 2.2.4 Java堆

Java堆内存是JVM管理的最大的一块内存区域，并且<font color="red">堆内存是被所有线程共享的</font>，由虚拟机启动时创建。Java堆内存的唯一目的就是存放对象实例，<font color="red">Java程序中几乎所有的对象实例都是在堆内存上分配的</font>。

将Java堆内存细分的目的是为了更好地回收内存、或者更快地分配内存。

Java堆内存可以处于物理上不连续的内存空间，逻辑是它被视为连续的。但是对于大对象（数组对象）多数虚拟机出于实现简单、存储高效的考虑，很可能会要求大对象存储在连续的内存空间。

目前主流的Java虚拟机的堆内存都是可以扩展的（<font color="red">由参数-Xmx和-Xms设定</font>）

**异常情况：**

1. OutOfMemoryError异常

   如果对内存没有足够多的内存来分配对象，并且堆内存内存不能再扩展时，JVM将会抛出OutOfMemoryError异常。

#### 2.2.5 方法区



#### 2.2.6 运行时常量池

#### 2.2.7 直接内存

### 2.3 HotSpot 虚拟机对象探秘

### 2.4 实战：OutOfMemoryError异常

### 2.5 本章小节

















<font color="red"></font>